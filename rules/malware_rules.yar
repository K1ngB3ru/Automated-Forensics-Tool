/*
    YARA Rules for Malware Detection
    Forensic Analysis Tool
*/

// ==================================================
// Registry-Based Persistence Detection
// ==================================================

rule Suspicious_Registry_Persistence
{
    meta:
        description = "Detects suspicious registry modification for persistence"
        author = "Forensic Analysis Tool"
        severity = "HIGH"
        category = "Persistence"
        
    strings:
        $reg1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg3 = "CurrentVersion\\RunOnce" nocase
        $reg4 = "\\Run\\" nocase
        
        $suspicious1 = "cmd.exe /c" nocase
        $suspicious2 = "powershell" nocase
        $suspicious3 = "wscript" nocase
        $suspicious4 = "cscript" nocase
        $suspicious5 = "mshta" nocase
        
    condition:
        any of ($reg*) and any of ($suspicious*)
}

// ==================================================
// Process Injection Indicators
// ==================================================

rule Process_Injection_Indicators
{
    meta:
        description = "Detects common process injection techniques"
        author = "Forensic Analysis Tool"
        severity = "HIGH"
        category = "Process Injection"
        
    strings:
        $api1 = "VirtualAllocEx" nocase
        $api2 = "WriteProcessMemory" nocase
        $api3 = "CreateRemoteThread" nocase
        $api4 = "NtCreateThreadEx" nocase
        $api5 = "QueueUserAPC" nocase
        $api6 = "SetThreadContext" nocase
        
    condition:
        2 of them
}

// ==================================================
// Network Communication Patterns
// ==================================================

rule Suspicious_Network_Activity
{
    meta:
        description = "Detects suspicious network communication patterns"
        author = "MetaProbe Team"
        severity = "MEDIUM"
        category = "Network"
        
    strings:
        $url1 = /https?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/ // IP-based URLs
        $url2 = ".onion" nocase // Tor addresses
        $url3 = ".bit" nocase // Blockchain DNS
        
        $port1 = ":4444" // Common Metasploit port
        $port2 = ":8080"
        $port3 = ":31337" // Elite port
        
        $protocol1 = "IRC" nocase
        $protocol2 = "SOCKS" nocase
        
    condition:
        any of ($url*) or any of ($port*) or any of ($protocol*)
}

// ==================================================
// Credential Theft Indicators
// ==================================================

rule Credential_Theft
{
    meta:
        description = "Detects potential credential theft activities"
        author = "Forensic Analysis Tool"
        severity = "CRITICAL"
        category = "Credential Access"
        
    strings:
        $cred1 = "mimikatz" nocase
        $cred2 = "sekurlsa" nocase
        $cred3 = "lsadump" nocase
        $cred4 = "SAM" nocase
        $cred5 = "SYSTEM" nocase
        $cred6 = "kerberos" nocase
        
        $file1 = "\\AppData\\Local\\Microsoft\\Credentials" nocase
        $file2 = "\\Windows\\System32\\config\\SAM" nocase
        $file3 = "lsass.exe" nocase
        
    condition:
        2 of ($cred*) or any of ($file*)
}

// ==================================================
// Ransomware Indicators
// ==================================================

rule Ransomware_Indicators
{
    meta:
        description = "Detects common ransomware behaviors"
        author = "Forensic Analysis Tool"
        severity = "CRITICAL"
        category = "Ransomware"
        
    strings:
        $encrypt1 = "CryptEncrypt" nocase
        $encrypt2 = "CryptGenKey" nocase
        $encrypt3 = "CryptAcquireContext" nocase
        
        $file1 = ".encrypted" nocase
        $file2 = ".locked" nocase
        $file3 = ".crypto" nocase
        $file4 = "DECRYPT" nocase
        $file5 = "RANSOM" nocase
        $file6 = "README" nocase
        
        $bitcoin = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ // Bitcoin address pattern
        
    condition:
        (2 of ($encrypt*)) or (2 of ($file*)) or $bitcoin
}

// ==================================================
// PowerShell Obfuscation
// ==================================================

rule PowerShell_Obfuscation
{
    meta:
        description = "Detects obfuscated PowerShell commands"
        author = "Forensic Analysis Tool"
        severity = "HIGH"
        category = "Execution"
        
    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        
        $obf1 = "-enc" nocase // Encoded command
        $obf2 = "-EncodedCommand" nocase
        $obf3 = "FromBase64String" nocase
        $obf4 = "DownloadString" nocase
        $obf5 = "DownloadFile" nocase
        $obf6 = "Invoke-Expression" nocase
        $obf7 = "IEX" nocase
        $obf8 = "-NoProfile" nocase
        $obf9 = "-WindowStyle Hidden" nocase
        
    condition:
        any of ($ps*) and 2 of ($obf*)
}

// ==================================================
// Suspicious File Extensions
// ==================================================

rule Suspicious_File_Extensions
{
    meta:
        description = "Detects suspicious or uncommon executable extensions"
        author = "Forensic Analysis Tool"
        severity = "MEDIUM"
        category = "File System"
        
    strings:
        $ext1 = ".scr" nocase // Screensaver
        $ext2 = ".pif" nocase // Program Information File
        $ext3 = ".com" nocase // DOS executable
        $ext4 = ".bat" nocase
        $ext5 = ".cmd" nocase
        $ext6 = ".vbs" nocase
        $ext7 = ".js" nocase
        $ext8 = ".jar" nocase
        $ext9 = ".msi" nocase
        
    condition:
        any of them
}

// ==================================================
// Browser Password Theft
// ==================================================

rule Browser_Credential_Theft
{
    meta:
        description = "Detects attempts to access browser stored credentials"
        author = "Forensic Analysis Tool"
        severity = "HIGH"
        category = "Credential Access"
        
    strings:
        $chrome1 = "\\Google\\Chrome\\User Data\\Default\\Login Data" nocase
        $chrome2 = "chrome_data" nocase
        
        $firefox1 = "\\Mozilla\\Firefox\\Profiles" nocase
        $firefox2 = "logins.json" nocase
        $firefox3 = "key4.db" nocase
        
        $edge1 = "\\Microsoft\\Edge\\User Data\\Default\\Login Data" nocase
        
        $sql1 = "SELECT origin_url, username_value, password_value FROM logins" nocase
        
    condition:
        any of them
}

// ==================================================
// Startup Folder Manipulation
// ==================================================

rule Startup_Folder_Persistence
{
    meta:
        description = "Detects files being placed in startup folders"
        author = "Forensic Analysis Tool"
        severity = "MEDIUM"
        category = "Persistence"
        
    strings:
        $startup1 = "\\Start Menu\\Programs\\Startup" nocase
        $startup2 = "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup" nocase
        $startup3 = "shell:startup" nocase
        
    condition:
        any of them
}

// ==================================================
// System Information Gathering
// ==================================================

rule System_Information_Gathering
{
    meta:
        description = "Detects system reconnaissance activities"
        author = "Forensic Analysis Tool"
        severity = "LOW"
        category = "Discovery"
        
    strings:
        $cmd1 = "systeminfo" nocase
        $cmd2 = "ipconfig" nocase
        $cmd3 = "netstat" nocase
        $cmd4 = "tasklist" nocase
        $cmd5 = "net user" nocase
        $cmd6 = "net localgroup" nocase
        $cmd7 = "whoami" nocase
        $cmd8 = "qwinsta" nocase
        
    condition:
        3 of them
}